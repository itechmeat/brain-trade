# План реализации функции чаевых (Tips) для BrainTrade

## Обзор функциональности

Добавление кнопки "Tips" в интерфейс чата с экспертами, которая позволяет пользователю отправить чаевые эксперту, округляя свой баланс токенов до красивого числа.

## Логика расчета чаевых

### Алгоритм округления баланса:
1. Текущий баланс пользователя (например: 174.999999999999999985 btBEN)
2. Целевой баланс: округление до ближайшего числа кратного 5 или 10
3. Сумма чаевых = Текущий баланс - Целевой баланс
4. Отображение суммы чаевых округлено до 2 знаков после запятой

### Примеры расчетов:
- Баланс: 174.999... → Цель: 165 → Чаевые: ~10.00
- Баланс: 127.543... → Цель: 125 → Чаевые: ~2.54
- Баланс: 193.821... → Цель: 190 → Чаевые: ~3.82

## Техническая реализация

### ☐ Этап 1: Смарт-контракт
- [ ] Добавить функцию `sendTip(address expert, uint256 amount)` в ExpertToken контракт
- [ ] Обновить ABI для включения новой функции
- [ ] Протестировать функцию на тестовой сети

### ☐ Этап 2: Утилиты расчета
- [ ] Создать `calculateTipAmount()` функцию для расчета суммы чаевых
- [ ] Добавить форматирование чисел с округлением до 2 знаков
- [ ] Создать валидацию минимальной/максимальной суммы чаевых

### ☐ Этап 3: UI компонент
- [ ] Создать компонент `TipButton` с предпросмотром суммы
- [ ] Добавить модальное окно подтверждения чаевых
- [ ] Реализовать состояния загрузки и успеха/ошибки
- [ ] Добавить стили для кнопки чаевых

### ☐ Этап 4: Интеграция с блокчейном
- [ ] Добавить функцию `sendTip()` в хук useContracts
- [ ] Обновить кэширование баланса после отправки чаевых
- [ ] Добавить обработку ошибок транзакций

### ☐ Этап 5: Интеграция в интерфейс
- [ ] Добавить кнопку Tips в интерфейс чата с экспертом
- [ ] Показывать кнопку только при достаточном балансе
- [ ] Обновлять баланс после успешной отправки чаевых

### ☐ Этап 6: Тестирование
- [ ] Протестировать с различными значениями баланса
- [ ] Проверить корректность расчетов
- [ ] Тестировать UX флоу от клика до подтверждения

## Файлы для изменения

### Смарт-контракты:
- `contracts/ExpertToken.sol` - добавить функцию sendTip
- `lib/blockchain/config.ts` - обновить ABI

### Утилиты:
- `lib/utils/tipCalculations.ts` - новый файл с логикой расчета
- `lib/utils/formatNumber.ts` - форматирование чисел

### Компоненты:
- `components/ui/TipButton/TipButton.tsx` - новый компонент
- `components/ui/TipButton/TipButton.module.scss` - стили
- `components/ui/TipConfirmModal/TipConfirmModal.tsx` - модальное окно

### Хуки:
- `hooks/useContracts.ts` - добавить функцию sendTip
- `hooks/useTips.ts` - новый хук для управления чаевыми

### Интерфейс:
- `components/tokenized-chat/TokenizedChatInterface.tsx` - интегрировать кнопку

## Технические детали

### Функция расчета чаевых:
```typescript
function calculateTipAmount(currentBalance: bigint, tokenDecimals: number = 18) {
  // Конвертация в число для расчетов
  const balanceNumber = Number(formatUnits(currentBalance, tokenDecimals));
  
  // Определение целевого баланса (округление до 5 или 10)
  const targetBalance = Math.floor(balanceNumber / 5) * 5;
  
  // Расчет суммы чаевых
  const tipAmount = balanceNumber - targetBalance;
  
  // Валидация (минимум 0.01, максимум 50)
  if (tipAmount < 0.01 || tipAmount > 50) return null;
  
  return {
    tipAmount: parseUnits(tipAmount.toFixed(18), tokenDecimals),
    tipAmountFormatted: tipAmount.toFixed(2),
    targetBalance: targetBalance.toFixed(2)
  };
}
```

### Смарт-контракт функция:
```solidity
function sendTip(address to, uint256 amount) external {
    require(balanceOf(msg.sender) >= amount, "Insufficient balance");
    _transfer(msg.sender, to, amount);
    emit TipSent(msg.sender, to, amount);
}
```

## Критерии готовности

### Функциональные требования:
- ✅ Кнопка "Tips" отображается в интерфейсе чата
- ✅ Корректный расчет суммы чаевых с округлением баланса
- ✅ Предпросмотр суммы чаевых до подтверждения
- ✅ Успешная отправка чаевых через смарт-контракт
- ✅ Обновление баланса после транзакции

### Технические требования:
- ✅ Все функции протестированы
- ✅ Нет ошибок TypeScript
- ✅ Код проходит линтер
- ✅ Компоненты соответствуют дизайн-системе проекта

### UX требования:
- ✅ Интуитивно понятный интерфейс
- ✅ Обратная связь для всех состояний (загрузка, успех, ошибка)
- ✅ Адаптивность под разные размеры экрана

## Временные оценки

- **Этап 1-2**: ~2 часа (смарт-контракт + утилиты)
- **Этап 3**: ~3 часа (UI компоненты)
- **Этап 4**: ~2 часа (интеграция с блокчейном)
- **Этап 5**: ~1 час (интеграция в интерфейс)
- **Этап 6**: ~1 час (тестирование)

**Общее время**: ~9 часов

## Риски и ограничения

1. **Точность расчетов**: Работа с bigint и округлением может привести к ошибкам
2. **Газовые комиссии**: Нужно учесть стоимость транзакций
3. **UX**: Пользователи могут не понимать логику округления
4. **Безопасность**: Проверка на достаточность баланса и защита от атак

## Следующие шаги

1. Начать с реализации смарт-контракта
2. Создать утилиты для расчетов
3. Разработать UI компоненты
4. Интегрировать все части вместе
5. Провести тестирование