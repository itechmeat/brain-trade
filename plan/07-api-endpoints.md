# Этап 7: API эндпоинты для чатов

## Разработка API для работы с чатами и экспертами

### Шаг 7.1: Базовые API маршруты
- [ ] Создать структуру API в `src/app/api/`:
  ```
  src/app/api/
  ├── chats/
  │   ├── route.ts (GET, POST)
  │   └── [id]/
  │       ├── route.ts (GET, PUT, DELETE)
  │       └── messages/
  │           └── route.ts (GET, POST)
  ├── experts/
  │   ├── route.ts (GET)
  │   └── [id]/
  │       └── route.ts (GET)
  ├── chat-stream/
  │   └── route.ts (POST - streaming)
  └── rag/
      ├── search/
      │   └── route.ts (POST)
      └── index/
          └── route.ts (POST)
  ```

### Шаг 7.2: API для управления чатами
- [ ] Создать `src/app/api/chats/route.ts`:
  - GET `/api/chats` - получить список чатов
  - POST `/api/chats` - создать новый чат
- [ ] Создать `src/app/api/chats/[id]/route.ts`:
  - GET `/api/chats/[id]` - получить чат по ID
  - PUT `/api/chats/[id]` - обновить чат
  - DELETE `/api/chats/[id]` - удалить чат

### Шаг 7.3: API для сообщений
- [ ] Создать `src/app/api/chats/[id]/messages/route.ts`:
  - GET `/api/chats/[id]/messages` - получить сообщения чата
  - POST `/api/chats/[id]/messages` - отправить сообщение и получить ответы экспертов

### Шаг 7.4: Streaming API для реального времени
- [ ] Создать `src/app/api/chat-stream/route.ts`:
  - POST `/api/chat-stream` - отправить сообщение и получить streaming ответы
  - Реализовать Server-Sent Events (SSE) для получения ответов в реальном времени
  - Поддержка множественных экспертов одновременно

### Шаг 7.5: API для экспертов
- [ ] Создать `src/app/api/experts/route.ts`:
  - GET `/api/experts` - получить список доступных экспертов
- [ ] Создать `src/app/api/experts/[id]/route.ts`:
  - GET `/api/experts/[id]` - получить информацию об эксперте

### Шаг 7.6: RAG API эндпоинты
- [ ] Создать `src/app/api/rag/search/route.ts`:
  - POST `/api/rag/search` - поиск релевантной информации
  - Поддержка фильтрации по экспертам
- [ ] Создать `src/app/api/rag/index/route.ts`:
  - POST `/api/rag/index` - индексирование новых документов

### Шаг 7.7: Middleware для API
- [ ] Интегрировать middleware из предыдущих этапов:
  - CORS для кросс-доменных запросов
  - Аутентификация (если требуется)
  - Rate limiting
  - Логирование запросов

### Шаг 7.8: Обработка ошибок в API
- [ ] Создать централизованную обработку ошибок
- [ ] Добавить стандартизированные ответы для ошибок:
  ```typescript
  interface ErrorResponse {
    error: string;
    message: string;
    code: number;
    details?: any;
  }
  ```
- [ ] Реализовать логирование ошибок

### Шаг 7.9: Валидация входящих данных
- [ ] Добавить валидацию запросов с использованием Zod
- [ ] Создать схемы валидации для каждого эндпоинта
- [ ] Добавить sanitization входящих данных

### Шаг 7.10: Логика множественных экспертов
- [ ] Реализовать параллельную обработку запросов к разным экспертам
- [ ] Добавить логику для объединения контекста от разных экспертов
- [ ] Создать алгоритм для балансировки нагрузки между LLM провайдерами

### Шаг 7.11: Кеширование и оптимизация
- [ ] Добавить кеширование для часто запрашиваемых данных
- [ ] Оптимизировать запросы к базе данных
- [ ] Реализовать pagination для списков

### Шаг 7.12: Тестирование API
- [ ] Создать тестовые файлы для каждого эндпоинта:
  - `test-chats-api.js`
  - `test-experts-api.js`
  - `test-streaming-api.js`
  - `test-rag-api.js`
- [ ] Проверить работу с различными HTTP методами
- [ ] Протестировать обработку ошибок

### Шаг 7.13: Документация API
- [ ] Создать OpenAPI/Swagger спецификацию
- [ ] Добавить JSDoc комментарии к API функциям
- [ ] Создать примеры использования API

## Результат этапа
После завершения этого этапа у вас будет:
- ✅ Полный набор API эндпоинтов для чатов
- ✅ Streaming API для реального времени
- ✅ API для управления экспертами
- ✅ RAG API для поиска информации
- ✅ Middleware для безопасности и производительности
- ✅ Обработка ошибок и валидация данных
- ✅ Оптимизация и кеширование
- ✅ Тестирование и документация API